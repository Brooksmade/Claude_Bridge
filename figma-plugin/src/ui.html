<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      padding: 12px;
      gap: 12px;
      background: var(--figma-color-bg, #fff);
      color: var(--figma-color-text, #333);
      display: flex;
      flex-direction: column;
    }

    /* ── Header ── */
    .header {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .status-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--figma-color-icon-tertiary, #ccc);
      flex-shrink: 0;
    }

    .status-indicator.connected {
      background: #21c55e;
    }

    .status-indicator.disconnected {
      background: var(--figma-color-bg-danger, #ef4444);
    }

    .status-indicator.connecting {
      background: var(--figma-color-bg-warning, #f59e0b);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      color: var(--figma-color-text-secondary, #666);
      font-size: 11px;
    }

    .download-btn {
      margin-left: auto;
      background: none;
      border: 1px solid var(--figma-color-border, #e5e5e5);
      cursor: pointer;
      color: #999;
      font-family: inherit;
      font-size: 11px;
      height: 30px;
      padding: 0 10px;
      border-radius: 6px;
      transition: background 0.15s;
    }

    .download-btn:hover {
      background: var(--figma-color-bg-tertiary, rgba(0, 0, 0, 0.06));
    }

    /* ── Separator ── */
    .separator {
      height: 1px;
      background: var(--figma-color-border, #e5e5e5);
    }

    /* ── Stats ── */
    .stats {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stat-label {
      color: var(--figma-color-text-secondary, #666);
      font-size: 11px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
    }

    .error-toggle {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 6px;
      height: 30px;
      padding: 0 10px;
      border: 1px solid var(--figma-color-border, #e5e5e5);
      border-radius: 6px;
      margin-left: auto;
      transition: background 0.15s, border-color 0.15s;
    }

    .error-toggle .stat-label {
      color: var(--figma-color-text-secondary, #666);
    }

    .error-toggle:hover {
      background: var(--figma-color-bg-tertiary, rgba(0, 0, 0, 0.06));
    }

    .error-toggle.filter-active {
      background: rgba(56, 132, 255, 0.08);
      border-color: rgba(56, 132, 255, 0.5);
    }

    .error-toggle.filter-active:hover {
      background: rgba(56, 132, 255, 0.14);
    }

    /* ── Log container (holds command box + scrollable entries) ── */
    .log {
      background: #f2f2f2;
      border-radius: 10px;
      padding: 8px;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: inset 0 8px 8px -4px rgba(0,0,0,0.1), inset 0 20px 24px -4px rgba(0,0,0,0.1);
    }

    html.figma-dark .log {
      box-shadow: inset 0 8px 8px -4px rgba(0,0,0,0.1), inset 0 20px 24px -4px rgba(0,0,0,0.1);
      background: #262626;
    }

    /* ── Command box (inside log) ── */
    .current-command {
      background: var(--figma-color-bg, #fff);
      border-radius: 6px;
      padding: 10px;
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
      box-shadow: 0 8px 8px -4px rgba(0,0,0,0.1), 0 20px 24px -4px rgba(0,0,0,0.1);
    }

    .current-command.active {
      background: #edf2ff;
    }

    html.figma-dark .current-command.active {
      background: #1a2340;
    }

    .current-command-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(56, 132, 255, 0.5);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }

    .current-command.active .spinner {
      display: block;
    }

    html.figma-dark .spinner {
      border-color: rgba(91, 140, 255, 0.5);
      border-top-color: transparent;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .current-command-title {
      font-weight: 600;
      font-size: 11px;
      color: var(--figma-color-text-secondary, #666);
    }

    .current-command.active .current-command-title {
      color: #386bd8;
    }

    html.figma-dark .current-command.active .current-command-title {
      color: #5b8cff;
    }

    .current-command-details {
      display: flex;
      margin-left: auto;
      font-size: 11px;
      color: var(--figma-color-text-secondary, #666);
    }

    .current-command.active .current-command-details {
      color: #4c7fd8;
    }

    html.figma-dark .current-command.active .current-command-details {
      color: #4d7ad9;
    }

    .current-command-type {
      font-family: inherit;
    }

    /* ── Log entries (scrollable) ── */
    .log-entries {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 10px;
      line-height: 1.5;
      padding-top: 1px;
    }

    /* Scrollbar styling — theme-aware */
    .log-entries::-webkit-scrollbar {
      width: 6px;
    }

    .log-entries::-webkit-scrollbar-track {
      background: transparent;
    }

    .log-entries::-webkit-scrollbar-thumb {
      background: #bbb;
      border-radius: 3px;
    }

    .log-entries::-webkit-scrollbar-thumb:hover {
      background: #999;
    }

    html.figma-dark .log-entries::-webkit-scrollbar-thumb {
      background: #444;
    }

    html.figma-dark .log-entries::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid rgba(200, 200, 200, 0.6);
    }

    html.figma-dark .log-entry {
      border-bottom-color: rgba(100, 100, 100, 0.6);
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-entry.error {
      color: #dc2626;
    }

    html.figma-dark .log-entry.error {
      color: #f87171;
    }

    .log-entry.success {
      color: #15803d;
    }

    html.figma-dark .log-entry.success {
      color: #21c55e;
    }

    .log-entry.executing {
      color: #2954b0;
    }

    html.figma-dark .log-entry.executing {
      color: #5b8cff;
    }

    .log-entries.errors-only .log-entry:not(.error) {
      display: none;
    }

    .log-time {
      color: #666;
      margin-right: 6px;
    }

    html.figma-dark .log-time {
      color: #999;
    }

    /* ── Version banner ── */
    .version-banner {
      border-radius: 6px;
      padding: 8px;
      font-size: 11px;
      display: none;
    }

    .version-banner.visible {
      display: block;
    }

    .version-banner.error {
      background: var(--figma-color-bg-danger, #fef2f2);
      border: 1px solid var(--figma-color-border-danger, #ef4444);
      color: var(--figma-color-text-danger, #b91c1c);
    }

    .version-banner.warning {
      background: #fffbeb;
      border: 1px solid #f59e0b;
      color: #92400e;
    }

    html.figma-dark .version-banner.warning {
      background: rgba(245, 158, 11, 0.1);
      border-color: rgba(245, 158, 11, 0.4);
      color: #fbbf24;
    }

    .version-banner.info {
      background: #eff6ff;
      border: 1px solid #3b82f6;
      color: #1e40af;
    }

    html.figma-dark .version-banner.info {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.4);
      color: #93c5fd;
    }

    .version-banner-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .version-banner-dismiss {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      padding: 0 2px;
      color: inherit;
      opacity: 0.6;
    }

    .version-banner-dismiss:hover {
      opacity: 1;
    }

    /* ── Pending close notice ── */
    .pending-close-notice {
      background: var(--figma-color-bg-danger, #fef2f2);
      border: 1px solid var(--figma-color-border-danger, #ef4444);
      border-radius: 6px;
      padding: 8px;
      font-size: 11px;
      color: var(--figma-color-text-danger, #b91c1c);
      display: none;
    }

    .pending-close-notice.visible {
      display: block;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="status-group">
      <span id="statusText" class="status-text">Connecting...</span>
      <div id="statusIndicator" class="status-indicator connecting"></div>
    </div>
    <button id="downloadBtn" class="download-btn" style="display:none">Download Server</button>
  </div>

  <div class="separator"></div>

  <div id="versionBanner" class="version-banner" style="display: none;">
    <div class="version-banner-content">
      <span id="versionBannerMessage"></span>
      <button id="versionBannerDismiss" class="version-banner-dismiss" style="display: none;">&times;</button>
    </div>
  </div>

  <div id="pendingCloseNotice" class="pending-close-notice">
    Closing after current command finishes...
  </div>

  <div class="stats">
    <div class="stat">
      <div class="stat-label">Commands</div>
      <div id="commandCount" class="stat-value">0</div>
    </div>
    <div id="errorStat" class="error-toggle" title="Toggle: show errors only">
      <div class="stat-label">View Errors</div>
      <div id="errorCount" class="stat-value">0</div>
    </div>
  </div>

  <div class="log" id="log">
    <div id="currentCommand" class="current-command">
      <div class="current-command-header">
        <div class="spinner"></div>
        <span id="currentCommandTitle" class="current-command-title">Ready</span>
      </div>
      <div class="current-command-details">
        <span id="currentCommandType" class="current-command-type">Waiting for commands...</span>
      </div>
    </div>
    <div class="log-entries" id="logEntries">
      <div class="log-entry">Initializing...</div>
    </div>
  </div>

  <script src="ui.js"></script>
</body>
</html>
